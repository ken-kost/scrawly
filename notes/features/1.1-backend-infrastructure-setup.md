# Feature: Backend Infrastructure Setup

## Summary
Establish the core Ash application structure for the Scrawly multiplayer drawing game, including domain contexts for Game, Room, and Player with proper resources, PostgreSQL data layer, and authentication configuration.

## Requirements
- [ ] Create Game domain context with resources for game-related entities
- [ ] Create Room domain context with resources for room management 
- [ ] Create Player domain context with resources for player management
- [ ] Configure Ash resources with proper attributes and actions
- [ ] Set up PostgreSQL data layer with ash_postgres for all new resources
- [ ] Configure Ash authentication for player sessions (extending existing pattern)
- [ ] Ensure all new domains are properly registered in application config
- [ ] Write unit tests for resource creation and validation
- [ ] Write unit tests for domain context boundaries  
- [ ] Write unit tests for database migrations and schema
- [ ] Write unit tests for authentication token generation

## Research Summary
### Existing Usage Rules Checked
- Ash usage rules: Focus on domain-driven structure, code interfaces, avoid direct Ash calls in web modules
- AshPostgres usage rules: Use data_layer: AshPostgres.DataLayer, configure table/repo in postgres block
- AshAuthentication usage rules: Enable tokens, use strategies appropriately, manage secrets properly

### Documentation Reviewed
- Ash: Declarative framework with resources at center, use domain-specific actions, organize around domains
- AshPostgres: PostgreSQL data layer, table/repo configuration required in postgres block
- AshAuthentication: Already configured with magic_link strategy, tokens enabled

### Existing Patterns Found
- Domain: Scrawly.Accounts (lib/scrawly/accounts.ex) - shows proper domain structure with resources
- Resource: Scrawly.Accounts.User (lib/scrawly/accounts/user.ex) - shows proper resource configuration with postgres, actions, policies
- Authentication: Already configured with magic_link strategy and tokens
- Config: config/config.exs shows ash_domains: [Scrawly.Accounts] pattern

### Technical Approach
1. Use `mix ash.gen.domain` to create new domains following existing pattern
2. Use `mix ash.gen.resource` to create resources within each domain
3. Configure PostgreSQL data layer using existing Scrawly.Repo
4. Extend authentication using existing token/user pattern for player sessions
5. Follow existing code organization with lib/scrawly/{domain}/{resource}.ex structure
6. Register new domains in config/config.exs ash_domains list
7. Create proper unit tests in test/ directory following Ash testing patterns

## Risks & Mitigations
| Risk | Impact | Mitigation |
|------|--------|------------|
| Resource naming conflicts | Medium | Follow clear naming conventions with domain prefixes |
| Database migration conflicts | High | Use ash.generate_migrations and review before applying |
| Authentication integration complexity | Medium | Extend existing pattern rather than create new one |
| Missing domain registration | Medium | Verify config.exs updates and test domain loading |

## Implementation Checklist
- [ ] Create Game domain module (lib/scrawly/game.ex)
- [ ] Create Room domain module (lib/scrawly/room.ex) 
- [ ] Create Player domain module (lib/scrawly/player.ex)
- [ ] Create initial Game resources (lib/scrawly/game/)
- [ ] Create initial Room resources (lib/scrawly/room/)
- [ ] Create initial Player resources (lib/scrawly/player/)
- [ ] Configure PostgreSQL for all new resources
- [ ] Update config/config.exs to register new domains
- [ ] Extend authentication for player sessions
- [ ] Generate and run database migrations
- [ ] Write comprehensive unit tests
- [ ] Verify no compilation errors or warnings

## Questions for Zach
1. Should the Player resource be separate from the existing User resource, or should we extend User with player-specific attributes? ✅ **ANSWERED: Extend User**
2. Do you want separate domains for Game/Room/Player or would a single Games domain be preferred? ✅ **ANSWERED: Single Games domain**
3. Should we implement player authentication as a separate strategy or extend the existing magic_link pattern? ✅ **ANSWERED: Extend magic_link**

## Implementation Log

### Completed:
- ✅ Created Scrawly.Games domain with AshAdmin integration
- ✅ Created Room resource with attributes: code, status, max_players, current_round, timestamps
- ✅ Created Game resource with attributes: status, current_round, total_rounds, current_word, current_drawer_id, timestamps
- ✅ Extended User resource with player attributes: username, score, player_state, current_room_id
- ✅ Added player-specific actions to User: join_room, leave_room, update_score, set_player_state
- ✅ Configured PostgreSQL data layer for all resources using Scrawly.Repo
- ✅ Set up proper relationships between Room ↔ User and Game ↔ Room/User
- ✅ Added room code generation using :crypto.strong_rand_bytes
- ✅ Generated and applied database migrations successfully
- ✅ Updated config.exs to register Scrawly.Games domain
- ✅ Created comprehensive unit tests for all new functionality
- ✅ Verified compilation without warnings or errors

### Key Implementation Details:
- Room codes auto-generated as 6-character uppercase strings
- Room status: :lobby, :playing, :ended
- Player states: :connected, :drawing, :guessing, :disconnected
- Game status: :in_progress, :completed, :cancelled
- All constraints and validations implemented
- Proper foreign key relationships established
- Tests cover CRUD operations, validations, and business logic

## Final Implementation

All Phase 1.1 requirements have been successfully implemented:
- ✅ Initialize Ash application structure
- ✅ Create domain contexts for Game, Room, and Player (unified under Games)
- ✅ Configure Ash resources with proper attributes and actions
- ✅ Set up PostgreSQL data layer with ash_postgres
- ✅ Configure Ash authentication for player sessions (extended existing pattern)
- ✅ Unit tests for resource creation and validation
- ✅ Unit tests for domain context boundaries
- ✅ Unit tests for database migrations and schema
- ✅ Unit tests for authentication token generation (via existing User functionality)
