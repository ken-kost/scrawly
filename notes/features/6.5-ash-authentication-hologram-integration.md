# Feature: Ash Authentication Integration with Hologram Pages

## Summary
Integrate Ash Authentication with Hologram frontend pages to require user authentication for accessing the home and game pages, enabling registration via magic link email authentication and ensuring proper user context throughout the application.

## Requirements
- [ ] Enable authentication requirement for Hologram HomePage (/)
- [ ] Enable authentication requirement for Hologram GamePage (/game/:room_id)
- [ ] Integrate magic link authentication (:request_magic_link action) for user registration
- [ ] Access authenticated user data within Hologram pages from Phoenix session
- [ ] Update Hologram pages to use real user data instead of placeholder "current-user-id"
- [ ] Ensure proper redirects to sign-in when user is not authenticated
- [ ] Update User resource to properly accept player-related attributes during registration
- [ ] Test authentication flow with Hologram pages
- [ ] Verify user context is properly maintained across page navigation

## Research Summary

### Existing Usage Rules Checked
- **Ash Authentication**: Magic link strategy already configured in User resource with registration enabled
- **Phoenix Router**: ash_authentication_live_session :authenticated_routes scope exists but currently unused
- **Hologram**: Pages can access session data via server parameter in init/3 function using get_session/2

### Documentation Reviewed
- **AshAuthentication.Phoenix**: Provides router helpers and plugs for Phoenix integration
- **Hologram Session**: Pages can access Phoenix session data through server parameter in init function
- **AshAuthentication.Plug.Helpers**: load_from_session plug already configured in browser pipeline

### Existing Patterns Found
- Pattern 1: [lib/scrawly_web/router.ex:27-38] ash_authentication_live_session scope with LiveUserAuth callbacks
- Pattern 2: [lib/scrawly_web/live_user_auth.ex:24-29] :live_user_required callback redirects to /sign-in
- Pattern 3: [deps/hologram/test/features/app/pages/session/page_2.ex:8-9] get_session(server, "key") for accessing session data
- Pattern 4: [lib/scrawly/accounts/user.ex:86-92] :request_magic_link action already implemented
- Pattern 5: [lib/scrawly_web/controllers/page_controller.ex:10-13] Hologram.Controller.handle_initial_page_request integration

### Technical Approach
1. **Create Hologram Authentication Module**: Build a Hologram-specific authentication helper that can check session data and redirect unauthenticated users
2. **Modify Router Configuration**: Move Hologram routes inside the ash_authentication_live_session scope to enable authentication
3. **Update Hologram Pages**: Modify HomePage and GamePage init functions to:
   - Access current user from session using get_session(server, "current_user") or similar
   - Redirect to sign-in page if user is not authenticated
   - Use real user ID instead of placeholder values
4. **Session Integration**: Ensure that Ash Authentication properly stores user data in Phoenix session that Hologram can access
5. **Update User Resource**: Ensure the User resource accepts all necessary attributes for game functionality during registration
6. **Router Pipeline**: Configure proper authentication pipeline for Hologram routes

## Risks & Mitigations
| Risk | Impact | Mitigation |
|------|--------|------------|
| Hologram session access incompatibility with Ash Authentication | High | Test session data structure, use AshAuthentication.Phoenix.LiveSession patterns |
| Authentication redirects breaking Hologram page navigation | Medium | Implement Hologram-compatible redirect mechanism using put_page/2 |
| Session data not persisting across Hologram page transitions | Medium | Verify Phoenix session configuration with Hologram.Router |
| Magic link registration flow not working with Hologram pages | Medium | Test complete auth flow, ensure proper redirect after successful authentication |
| User resource missing required game attributes during registration | Low | Update User resource create action to accept game-related fields |

## Implementation Checklist
- [ ] Create `lib/scrawly_web/hologram_auth.ex` - Authentication helper for Hologram pages
- [ ] Modify `lib/scrawly_web/router.ex` - Move Hologram routes to authenticated scope
- [ ] Update `lib/scrawly_web/pages/home_page.ex` - Add authentication check and user context
- [ ] Update `lib/scrawly_web/pages/game_page.ex` - Add authentication check and real user data
- [ ] Update `lib/scrawly/accounts/user.ex` - Ensure create action accepts all required attributes
- [ ] Test authentication flow with Hologram pages
- [ ] Test magic link registration and redirect flow
- [ ] Verify user context persists across page navigation
- [ ] Write unit tests for authentication integration

## Questions for Ken
1. Should the magic link registration automatically redirect users back to the page they were trying to access, or always redirect to the home page?
2. Do you want to require users to set a username during the magic link registration flow, or should that be handled separately after authentication?
3. Should unauthenticated users be able to see any part of the home page (like a landing page), or should they be immediately redirected to sign-in?
